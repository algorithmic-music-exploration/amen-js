<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
	<title>Amen Test</title>
</head>

<body>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript" src="amen.js"></script>
<script type="text/javascript">

var doRemix = function(urls) {
  var context = new AudioContext();
  var trackUrl = urls.audio;
  var analysisUrl = urls.analysis;

  var amen = initializeAmen(context, $);
  var player = amen.getPlayer();

  amen.loadTrack(analysisUrl, trackUrl, function(t, percent) {
    console.log(percent);
    if (t.status = "ok" && percent == 100) {
      console.log("track has loaded");
      var out = []
      out.push(t.analysis.beats[4]);
      out.push(t.analysis.beats[4]);
      out.push(t.analysis.beats[4]);
      out.push(t.analysis.beats[4]);
      out.push(t.analysis.beats[0]);
      out.push(t.analysis.beats[0]);
      player.play(0, out);
    }
  });
}
 
var pollUrl = function(url, fn, data, time){
  $.ajax({
    url : url,
    type : 'HEAD',
    success : function(){
      fn(data);
      console.log("200!");
    },
    error : function(){
      console.log("fail, waiting for ", time);
      setTimeout(function() {
        pollUrl(url, fn, data, time + time / 2);
      }, time);
    }
  });
}

var responseHandler = function(res) {
  if (res.target.readyState === 4) {
    var urls = $.parseJSON(res.target.response);
    console.log(urls);
    pollUrl(urls.audio, doRemix, urls, 200);
  } 
}

var uploadFile = function() {
  var input = $("input")[0];
	var file = input.files[0];
	var fd = new FormData();
	fd.append('file', file);
	console.log("about to upload", fd);

	var xhr = new XMLHttpRequest();
	var url = 'http://tide-pool.link/amen-test';
	xhr.open('POST', url, true);
	xhr.onreadystatechange = responseHandler;
	xhr.send(fd);
	console.log("req sent!");
}

</script>

<form enctype="multipart/form-data" action="/upload/image" method="post">
    <input id="file" type="file" />
</form>
<button onclick="uploadFile()">Upload!</button>

</body>
</html>
